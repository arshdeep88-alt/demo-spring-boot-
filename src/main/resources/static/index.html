<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Demo CRUD App</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="max-w-5xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-md">
    <h1 class="text-3xl font-bold text-blue-600 mb-6">Demo CRUD Operations</h1>

    <!-- Form -->
    <form id="demoForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <input type="number" id="id" placeholder="ID" class="border p-2 rounded" required />
        <input type="text" id="name" placeholder="Name" class="border p-2 rounded" required />
        <input type="number" id="age" placeholder="Age" class="border p-2 rounded" required />
        <input type="text" id="address" placeholder="Address" class="border p-2 rounded" required />
        <button type="submit" class="md:col-span-4 bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">Submit</button>
    </form>

    <!-- Alert -->
    <div id="alert" class="hidden mb-4 p-3 rounded text-white"></div>

    <!-- Data Table -->
    <div class="overflow-x-auto">
        <table class="w-full table-auto border-collapse">
            <thead>
            <tr class="bg-blue-600 text-white">
                <th class="p-2">ID</th>
                <th class="p-2">Name</th>
                <th class="p-2">Age</th>
                <th class="p-2">Address</th>
                <th class="p-2">Actions</th>
            </tr>
            </thead>
            <tbody id="dataBody" class="bg-white"></tbody>
        </table>
    </div>
</div>

<!-- View Modal -->
<div id="viewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-10">
    <div class="bg-white p-6 rounded-lg w-96">
        <h2 class="text-xl font-bold text-blue-700 mb-4">View Details</h2>
        <p><strong>ID:</strong> <span id="viewId"></span></p>
        <p><strong>Name:</strong> <span id="viewName"></span></p>
        <p><strong>Age:</strong> <span id="viewAge"></span></p>
        <p><strong>Address:</strong> <span id="viewAddress"></span></p>
        <div class="mt-4 flex justify-between">
            <button onclick="editFromView()" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
            <button onclick="deleteFromView()" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
            <button onclick="closeModal()" class="bg-gray-400 text-white px-3 py-1 rounded hover:bg-gray-500">Close</button>
        </div>
    </div>
</div>

<script>
    const api = '/demo'; // No localhost:8080 hardcoding

    const form = document.getElementById('demoForm');
    const idField = document.getElementById('id');
    const nameField = document.getElementById('name');
    const ageField = document.getElementById('age');
    const addressField = document.getElementById('address');
    const dataBody = document.getElementById('dataBody');
    const alertBox = document.getElementById('alert');

    const viewModal = document.getElementById('viewModal');
    let currentViewId = null;

    // Load data
    async function loadData() {
      const res = await fetch(api);
      const data = await res.json();
      dataBody.innerHTML = '';
      data.forEach(d => {
        dataBody.innerHTML += `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2">${d.id}</td>
            <td class="p-2">${d.name}</td>
            <td class="p-2">${d.age}</td>
            <td class="p-2">${d.address}</td>
            <td class="p-2 space-x-2">
              <button onclick="viewData(${d.id})" class="text-blue-600 hover:underline">View</button>
            </td>
          </tr>
        `;
      });
    }

    // Alert
    function showAlert(message, type = 'success') {
      alertBox.textContent = message;
      alertBox.className = `mb-4 p-3 rounded text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      alertBox.classList.remove('hidden');
      setTimeout(() => alertBox.classList.add('hidden'), 3000);
    }

    // Form submit
    form.onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        id: parseInt(idField.value),
        name: nameField.value,
        age: parseInt(ageField.value),
        address: addressField.value,
      };

      try {
        const exists = await fetch(`${api}/${payload.id}`);
        const method = exists.ok ? 'PUT' : 'POST';
        const url = exists.ok ? `${api}/${payload.id}` : api;

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          showAlert(`Data ${method === 'POST' ? 'created' : 'updated'} successfully`);
          form.reset();
          loadData();
        } else {
          showAlert(`Failed to save data`, 'error');
        }
      } catch (err) {
        showAlert('Server error', 'error');
      }
    };

    // View Data
    async function viewData(id) {
      const res = await fetch(`${api}/${id}`);
      const data = await res.json();
      currentViewId = data.id;
      document.getElementById('viewId').textContent = data.id;
      document.getElementById('viewName').textContent = data.name;
      document.getElementById('viewAge').textContent = data.age;
      document.getElementById('viewAddress').textContent = data.address;
      viewModal.classList.remove('hidden');
      viewModal.classList.add('flex');
    }

    // Edit from modal
    function editFromView() {
      idField.value = document.getElementById('viewId').textContent;
      nameField.value = document.getElementById('viewName').textContent;
      ageField.value = document.getElementById('viewAge').textContent;
      addressField.value = document.getElementById('viewAddress').textContent;
      closeModal();
    }

    // Delete from modal
    async function deleteFromView() {
      if (!confirm("Are you sure you want to delete this record?")) return;
      try {
        const res = await fetch(`${api}/${currentViewId}`, { method: 'DELETE' });
        if (res.ok) {
          showAlert('Deleted successfully');
          closeModal();
          loadData();
        } else {
          showAlert('Failed to delete', 'error');
        }
      } catch {
        showAlert('Server error', 'error');
      }
    }

    // Close modal
    function closeModal() {
      viewModal.classList.add('hidden');
      viewModal.classList.remove('flex');
      currentViewId = null;
    }

    // Initial load
    loadData();
</script>

</body>
</html>
